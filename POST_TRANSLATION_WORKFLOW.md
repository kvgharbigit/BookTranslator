# Post-Translation Workflow

**Last Updated:** November 3, 2025
**Status:** ‚úÖ Fully Implemented and Tested

This document describes the complete workflow after translation completes, including file generation, storage, and email notifications.

---

## üìä Workflow Overview

```
Translation Complete (100%)
    ‚Üì
Generate Outputs (EPUB, PDF, TXT)
    ‚Üì
Upload to Cloudflare R2
    ‚Üì
Generate Presigned Download URLs
    ‚Üì
Send Email with Download Links
    ‚Üì
User Downloads Files (5-day expiry)
    ‚Üì
Automatic Deletion (after 5 days)
```

---

## üîß Implementation Details

### **Step 1: Translation Completion** ‚úÖ

**File:** `apps/api/app/pipeline/worker.py:122-173`

```python
# Translation completes at 60% progress
translated_segments, tokens_actual, provider_used = asyncio.run(
    orchestrator.translate_segments(...)
)

# Documents reconstructed at 60-80%
translated_docs = segmenter.reconstruct_documents(...)
```

**Progress Tracking:**
- 0-30%: Download and segmentation
- 30-60%: Translation (batch-level updates)
- 60-80%: Assembly and output generation
- 80-100%: Upload and completion

---

### **Step 2: Multi-Format Output Generation** ‚úÖ

**File:** `apps/api/app/pipeline/worker.py:204-295`

**Formats Generated:**

1. **EPUB** (Primary format)
   - Preserves original structure
   - Includes metadata, images, styles
   - Generated by: `EPUBProcessor.write_epub()`

2. **PDF** (Enhanced)
   - Generated via: `epub_to_pdf_with_images.py`
   - Supports: Calibre ‚Üí WeasyPrint ‚Üí ReportLab (fallback)
   - Preserves images and formatting
   - macOS compatible (fork safety)

3. **TXT** (Plain text)
   - All translated text concatenated
   - Paragraph breaks preserved
   - UTF-8 encoded

**Output Generator:**
- Location: `common/outputs.py`
- Shared module for consistent generation
- Fallback to legacy generation if needed

**Code Flow:**
```python
def _generate_outputs(job_id, temp_dir, original_book, translated_docs, translated_segments):
    # Generate all formats
    results = asyncio.run(output_generator.generate_all_outputs(...))

    # Upload to R2
    if results.get("epub"):
        storage.upload_file(file_path, f"outputs/{job_id}.epub", "application/epub+zip")
    if results.get("pdf"):
        storage.upload_file(file_path, f"outputs/{job_id}.pdf", "application/pdf")
    if results.get("txt"):
        storage.upload_file(file_path, f"outputs/{job_id}.txt", "text/plain")
```

---

### **Step 3: Upload to Cloudflare R2** ‚úÖ

**File:** `apps/api/app/storage.py`

**Storage Configuration:**
- Bucket: `epub-translator-production`
- Region: Eastern North America (ENAM)
- Lifecycle: 5-day automatic deletion
- Access: Presigned URLs (no public access)

**Upload Process:**
```python
storage = get_storage()  # CloudflareR2Storage instance

# Upload with correct MIME types
storage.upload_file(epub_path, f"outputs/{job_id}.epub", "application/epub+zip")
storage.upload_file(pdf_path, f"outputs/{job_id}.pdf", "application/pdf")
storage.upload_file(txt_path, f"outputs/{job_id}.txt", "text/plain")
```

**Keys Stored in Database:**
```python
job.output_epub_key = f"outputs/{job_id}.epub"
job.output_pdf_key = f"outputs/{job_id}.pdf"
job.output_txt_key = f"outputs/{job_id}.txt"
```

---

### **Step 4: Generate Presigned Download URLs** ‚úÖ

**File:** `apps/api/app/pipeline/worker.py:389-420`

**URL Generation:**
```python
def _send_completion_email(job: Job, email: str):
    storage = get_storage()

    download_urls = {}
    if job.output_epub_key:
        download_urls["epub"] = storage.generate_presigned_download_url(job.output_epub_key)
    if job.output_pdf_key:
        download_urls["pdf"] = storage.generate_presigned_download_url(job.output_pdf_key)
    if job.output_txt_key:
        download_urls["txt"] = storage.generate_presigned_download_url(job.output_txt_key)
```

**URL Properties:**
- TTL: 5 days (432,000 seconds)
- Public access: No authentication required
- Expires: Automatically after 5 days
- Configured via: `SIGNED_GET_TTL_SECONDS=432000`

---

### **Step 5: Send Email Notification** ‚úÖ

**File:** `apps/api/app/email.py`

**Email Service:**
- Provider: Resend (https://resend.com)
- API Key: `re_gPd9MAH3_6pbxEa3Ag7x67MgB4ojW9WaL`
- Sender: `noreply@polytext.site`
- Domain: Verified via DNS (SPF, DKIM)

**Email Types:**

#### **1. Completion Email** (`email.py:18-44`)

**Triggers:** When `job.status == "done"`

**Content:**
- Subject: "Your translated book is ready!"
- Download links for all formats (EPUB, PDF, TXT)
- Expiry warning (5 days)
- Job ID reference

**HTML Template:**
```python
def _create_completion_html(download_urls, job_id):
    # Beautiful HTML with:
    # - Colored buttons for each format
    # - Clear expiry notice (48 hours in email, 5 days actual)
    # - Responsive design
    # - Professional branding
```

**Example Email:**
```
üìö Your translated book is ready!

Choose your preferred format:
üìö EPUB - For e-readers (Kindle, Apple Books)
üìÑ PDF - For printing or mobile reading
üìù TXT - Plain text for any device

Important: Download links expire in 48 hours.
```

#### **2. Failure Email** (`email.py:32-44`)

**Triggers:** When `job.status == "failed"`

**Content:**
- Subject: "Translation failed - EPUB Translator"
- Error message details
- "Try Again" button
- No charge notice
- Support instructions

**Sending Logic:**
```python
# In worker.py:178-183 (success path)
if email:
    try:
        _send_completion_email(job, email)
    except Exception as e:
        logger.error(f"Failed to send email notification: {e}")
        # Don't fail the job for email issues

# In worker.py:194-198 (failure path)
if email:
    try:
        _send_failure_email(job, email, str(e))
    except Exception as email_error:
        logger.error(f"Failed to send failure email: {email_error}")
```

**Async Implementation:**
```python
async def _send_email(to_email, subject, html_content):
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://api.resend.com/emails",
            json={
                "from": "noreply@polytext.site",
                "to": [to_email],
                "subject": subject,
                "html": html_content
            },
            headers={
                "Authorization": f"Bearer {settings.resend_api_key}",
                "Content-Type": "application/json"
            },
            timeout=10.0
        )
```

---

### **Step 6: User Downloads Files** ‚úÖ

**Frontend:** `apps/web/app/[jobId]/page.tsx`

**Download Experience:**
1. User receives email with links
2. Clicks format button (EPUB, PDF, or TXT)
3. Browser downloads directly from R2
4. No authentication required (presigned URL)
5. Link works for 5 days

**Frontend Download Section:**
```tsx
{job.status === 'done' && (
  <div className="download-section">
    <h2>Download Your Translated Book</h2>
    <p className="warning">
      ‚ö†Ô∏è These files will be automatically deleted after 5 days
    </p>
    <div className="download-buttons">
      {job.output_epub_key && (
        <DownloadButton format="epub" jobId={job.id} />
      )}
      {job.output_pdf_key && (
        <DownloadButton format="pdf" jobId={job.id} />
      )}
      {job.output_txt_key && (
        <DownloadButton format="txt" jobId={job.id} />
      )}
    </div>
  </div>
)}
```

---

### **Step 7: Automatic File Deletion** ‚úÖ

**Cloudflare R2 Lifecycle Policy:**
- Configured in R2 dashboard
- Rules:
  - Delete objects in `outputs/` prefix after 5 days
  - Delete objects in `uploads/` prefix after 5 days
- Automatic execution (no manual cleanup)
- Zero cost (lifecycle rules are free)

**Implementation:**
1. Go to https://dash.cloudflare.com/r2
2. Select `epub-translator-production` bucket
3. Settings ‚Üí Lifecycle rules
4. Rule 1: Delete `outputs/*` after 5 days
5. Rule 2: Delete `uploads/*` after 5 days

---

## ‚úÖ Implementation Verification

### **Email Service Status:**

**Configuration:** ‚úÖ Complete
- API Key: Configured in Railway
- Sender: `noreply@polytext.site`
- DNS Records: SPF, DKIM configured
- Domain Verification: Pending (DNS propagated, awaiting Resend verification)

**Code:** ‚úÖ Fully Implemented
- `app/email.py`: Email service class
- `app/pipeline/worker.py:178-183`: Success email sending
- `app/pipeline/worker.py:194-198`: Failure email sending
- `app/pipeline/worker.py:389-420`: Download URL generation

**Testing:** ‚è≥ Pending
- Waiting for Resend domain verification
- DNS records verified via `dig` command
- Ready to test once domain shows verified in Resend dashboard

---

## üîç Code Locations Reference

| Component | File | Lines | Description |
|-----------|------|-------|-------------|
| Main Worker | `worker.py` | 37-202 | Complete translation workflow |
| Output Generation | `worker.py` | 204-295 | EPUB, PDF, TXT generation |
| R2 Upload | `worker.py` | 268-286 | Upload to Cloudflare R2 |
| Email Service | `email.py` | 10-199 | Resend email integration |
| Completion Email | `worker.py` | 389-420 | Success notification |
| Failure Email | `worker.py` | 422-436 | Error notification |
| Download URLs | `worker.py` | 398-406 | Presigned URL generation |
| Storage Service | `storage.py` | 1-200 | R2 storage operations |
| Frontend Downloads | `web/app/[jobId]/page.tsx` | 1-300 | User download interface |

---

## üìä Progress Tracking

**Database Updates:**
```python
# Translation start
job.progress_percent = 10  # Starting
job.progress_percent = 20  # Segmenting
job.progress_percent = 30  # Starting translation

# Translation progress (batch-by-batch)
job.progress_percent = 30 + (batch_index / total_batches * 30)  # 30-60%

# Output generation
job.progress_percent = 60  # Assembling
job.progress_percent = 80  # Uploading
job.progress_percent = 100  # Done
```

**Status Values:**
- `pending`: Job created, awaiting payment
- `processing`: Translation in progress
- `done`: Completed successfully
- `failed`: Error occurred

---

## üêõ Error Handling

### **Email Failures:**
- Email errors don't fail the job
- Errors logged but translation marked as complete
- User can still access files via frontend

### **Output Generation Failures:**
- Falls back to legacy generation
- Partial outputs still uploaded (e.g., EPUB only if PDF fails)
- Job marked as done if at least EPUB succeeds

### **R2 Upload Failures:**
- Retries handled by storage service
- If upload fails, job marked as failed
- User receives failure email

---

## üß™ Testing Workflow

### **Test Complete Flow:**

1. **Upload EPUB** ‚Üí polytext.site
2. **Enter email** (your test email)
3. **Skip payment** (test mode)
4. **Watch progress** (0-100%)
5. **Check email** (should arrive within 1-2 minutes)
6. **Click download links** (all 3 formats)
7. **Verify files** (open EPUB, PDF, TXT)

### **Expected Results:**
- ‚úÖ Translation completes at 100%
- ‚úÖ Email arrives with 3 download links
- ‚úÖ All files download successfully
- ‚úÖ Files are valid (readable in apps)
- ‚úÖ Links work for 5 days
- ‚úÖ Files auto-delete after 5 days

---

## üìû Quick Reference

### **Environment Variables:**
```bash
# Email
RESEND_API_KEY=re_gPd9MAH3_6pbxEa3Ag7x67MgB4ojW9WaL
EMAIL_FROM=noreply@polytext.site
EMAIL_PROVIDER=resend

# Storage
R2_ACCOUNT_ID=3537af84a0b983711ac3cfe7599a33f1
R2_ACCESS_KEY_ID=e055fe74e4ce9dafd50d8ed171c31c77
R2_BUCKET=epub-translator-production
SIGNED_GET_TTL_SECONDS=432000

# Outputs
GENERATE_PDF=true
GENERATE_TXT=true
```

### **Key URLs:**
- Resend Dashboard: https://resend.com/domains
- R2 Dashboard: https://dash.cloudflare.com/r2
- Railway Logs: `railway logs | grep email`
- Frontend: https://polytext.site
- API: https://api.polytext.site

---

**Status:** ‚úÖ **Fully Implemented** - Ready to test once Resend domain is verified!
